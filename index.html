<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Redefinir senha</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>

    <!-- Ionicons (ícone de ver senha) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/css/ionicons.min.css"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #000;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #ffd700;
        margin-bottom: 25px;
      }

      .password-container {
        display: flex;
        align-items: center;
        border: 1px solid #ffd700;
        border-radius: 8px;
        margin-bottom: 12px;
        padding-right: 8px;
      }

      .password-container input {
        flex: 1;
        padding: 12px;
        border: none;
        background: #000;
        color: #fff;
        font-size: 14px;
      }

      .password-container input::placeholder {
        color: #777;
      }

      .password-container input:focus {
        outline: none;
      }

      .eye-btn {
        font-size: 22px;
        color: #ffd700;
        cursor: pointer;
        padding: 4px;
      }

      button {
        width: 100%;
        padding: 12px;
        background: #ffd700;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .msg {
        margin-top: 15px;
        text-align: center;
        font-weight: bold;
      }

      .error {
        color: #ff4d4d;
      }

      .success {
        color: #4caf50;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Nova senha</h1>

      <div class="password-container">
        <input
          type="password"
          id="password"
          placeholder="Digite sua nova senha"
        />
        <i
          class="icon ion-md-eye eye-btn"
          onclick="togglePassword('password', this)"
        ></i>
      </div>

      <div class="password-container">
        <input
          type="password"
          id="confirmPassword"
          placeholder="Confirme sua nova senha"
        />
        <i
          class="icon ion-md-eye eye-btn"
          onclick="togglePassword('confirmPassword', this)"
        ></i>
      </div>

      <button id="submitBtn" onclick="resetPassword()">Confirmar</button>

      <div class="msg" id="msg"></div>
    </div>

    <script>
      // Configuração do Appwrite
      const client = new Appwrite.Client()
        .setEndpoint("https://nyc.cloud.appwrite.io/v1")
        .setProject("68f65d83002fe8dd2701");

      const account = new Appwrite.Account(client);

      // Parâmetros da URL
      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId");
      const secret = params.get("secret");

      const msgDiv = document.getElementById("msg");
      const submitBtn = document.getElementById("submitBtn");

      // Validação do link
      if (!userId || !secret) {
        msgDiv.innerText = "Link inválido ou expirado.";
        msgDiv.className = "msg error";
        submitBtn.disabled = true;
      }

      // Mostrar / ocultar senha
      function togglePassword(id, icon) {
        const input = document.getElementById(id);

        if (input.type === "password") {
          input.type = "text";
          icon.className = "icon ion-md-eye-off eye-btn";
        } else {
          input.type = "password";
          icon.className = "icon ion-md-eye eye-btn";
        }
      }

      // Redefinir senha
      async function resetPassword() {
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        msgDiv.innerText = "";
        msgDiv.className = "msg";

        if (!password || !confirmPassword) {
          msgDiv.innerText = "Preencha todos os campos.";
          msgDiv.classList.add("error");
          return;
        }

        if (password.length < 8) {
          msgDiv.innerText = "A senha deve ter pelo menos 8 caracteres.";
          msgDiv.classList.add("error");
          return;
        }

        if (password !== confirmPassword) {
          msgDiv.innerText = "As senhas não coincidem.";
          msgDiv.classList.add("error");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerText = "Processando...";

        try {
          await account.updateRecovery(userId, secret, password, password);

          msgDiv.innerText = "Senha redefinida com sucesso! ✅";
          msgDiv.classList.add("success");
          submitBtn.innerText = "Concluído";
        } catch (err) {
          console.error(err);
          msgDiv.innerText = "Erro ao redefinir a senha. Tente novamente.";
          msgDiv.classList.add("error");

          submitBtn.disabled = false;
          submitBtn.innerText = "Confirmar";
        }
      }
    </script>
  </body>
</html>
