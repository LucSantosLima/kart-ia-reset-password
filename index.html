<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Redefinir senha</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #000;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #ffd700;
      }

      input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 6px;
        border: 1px solid #ffd700;
        background: #000;
        color: #fff;
      }

      button {
        width: 100%;
        padding: 12px;
        background: #ffd700;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .msg {
        margin-top: 15px;
        text-align: center;
        font-weight: bold;
      }

      .error {
        color: #ff4d4d;
      }

      .success {
        color: #4caf50;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Nova senha</h1>

      <input
        type="password"
        id="password"
        placeholder="Digite sua nova senha"
      />

      <input
        type="password"
        id="confirmPassword"
        placeholder="Confirme sua nova senha"
      />

      <button id="submitBtn" onclick="resetPassword()">Confirmar</button>

      <div class="msg" id="msg"></div>
    </div>

    <script>
      // Configuração do Appwrite
      const client = new Appwrite.Client()
        .setEndpoint("https://nyc.cloud.appwrite.io/v1")
        .setProject("68f65d83002fe8dd2701");

      const account = new Appwrite.Account(client);

      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId");
      const secret = params.get("secret");

      const msgDiv = document.getElementById("msg");
      const submitBtn = document.getElementById("submitBtn");

      // Validação do link
      if (!userId || !secret) {
        msgDiv.innerText = "Link inválido ou expirado.";
        msgDiv.className = "msg error";
        submitBtn.disabled = true;
      }

      async function resetPassword() {
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        msgDiv.innerText = "";
        msgDiv.className = "msg";

        if (!password || !confirmPassword) {
          msgDiv.innerText = "Preencha todos os campos.";
          msgDiv.classList.add("error");
          return;
        }

        if (password.length < 8) {
          msgDiv.innerText = "A senha deve ter pelo menos 8 caracteres.";
          msgDiv.classList.add("error");
          return;
        }

        if (password !== confirmPassword) {
          msgDiv.innerText = "As senhas não coincidem.";
          msgDiv.classList.add("error");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerText = "Processando...";

        try {
          await account.updateRecovery(userId, secret, password, password);

          msgDiv.innerText = "Senha redefinida com sucesso! ✅";
          msgDiv.classList.add("success");

          submitBtn.innerText = "Concluído";
        } catch (err) {
          console.error(err);
          msgDiv.innerText = "Erro ao redefinir a senha. Tente novamente.";
          msgDiv.classList.add("error");

          submitBtn.disabled = false;
          submitBtn.innerText = "Confirmar";
        }
      }
    </script>
  </body>
</html>
