<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Redefinir senha</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #000;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #ffd700;
        margin-bottom: 25px;
      }

      /* ===== INPUTS ===== */
      .password-field {
        position: relative;
        width: 100%;
        margin-bottom: 14px;
      }

      .password-field input {
        width: 100%;
        height: 48px;
        padding: 0 52px 0 14px;
        border-radius: 8px;
        border: 1px solid #ffd700;
        background: #000;
        color: #fff;
        font-size: 15px;
        box-sizing: border-box;
      }

      .password-field input::placeholder {
        color: #777;
      }

      .password-field input:focus {
        outline: none;
      }

      /* ===== BOT√ÉO OLHO (FIX DEFINITIVO) ===== */
      .eye-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-80%);

        width: 36px;
        height: 36px;

        background: transparent;
        border: none;
        cursor: pointer;

        display: flex;
        align-items: center;
        justify-content: center;

        font-size: 18px;
        color: #ffd700;
        padding: 0;
        line-height: 1;
      }

      /* ===== BOT√ÉO CONFIRMAR ===== */
      button {
        width: 100%;
        height: 48px;
        background: #ffd700;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        margin-top: 14px;
        color: #000;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .msg {
        margin-top: 15px;
        text-align: center;
        font-weight: bold;
      }

      .error {
        color: #ff4d4d;
      }

      .success {
        color: #4caf50;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Nova senha</h1>

      <div class="password-field">
        <input
          type="password"
          id="password"
          placeholder="Digite sua nova senha"
        />
        <button
          type="button"
          class="eye-btn"
          onclick="togglePassword('password', this)"
        >
          üëÅ
        </button>
      </div>

      <div class="password-field">
        <input
          type="password"
          id="confirmPassword"
          placeholder="Confirme sua nova senha"
        />
        <button
          type="button"
          class="eye-btn"
          onclick="togglePassword('confirmPassword', this)"
        >
          üëÅ
        </button>
      </div>

      <button id="submitBtn" onclick="resetPassword()">Confirmar</button>

      <div class="msg" id="msg"></div>
    </div>

    <script>
      const client = new Appwrite.Client()
        .setEndpoint("https://nyc.cloud.appwrite.io/v1")
        .setProject("68f65d83002fe8dd2701");

      const account = new Appwrite.Account(client);

      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId");
      const secret = params.get("secret");

      const msgDiv = document.getElementById("msg");
      const submitBtn = document.getElementById("submitBtn");

      if (!userId || !secret) {
        msgDiv.innerText = "Link inv√°lido ou expirado.";
        msgDiv.className = "msg error";
        submitBtn.disabled = true;
      }

      function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);

        if (input.type === "password") {
          input.type = "text";
          btn.textContent = "üôà";
        } else {
          input.type = "password";
          btn.textContent = "üëÅ";
        }
      }

      async function resetPassword() {
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        msgDiv.innerText = "";
        msgDiv.className = "msg";

        if (!password || !confirmPassword) {
          msgDiv.innerText = "Preencha todos os campos.";
          msgDiv.classList.add("error");
          return;
        }

        if (password.length < 8) {
          msgDiv.innerText = "A senha deve ter pelo menos 8 caracteres.";
          msgDiv.classList.add("error");
          return;
        }

        if (password !== confirmPassword) {
          msgDiv.innerText = "As senhas n√£o coincidem.";
          msgDiv.classList.add("error");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerText = "Processando...";

        try {
          await account.updateRecovery(userId, secret, password, password);
          msgDiv.innerText = "Senha redefinida com sucesso! ‚úÖ";
          msgDiv.classList.add("success");
          submitBtn.innerText = "Conclu√≠do";
        } catch (err) {
          console.error(err);
          msgDiv.innerText = "Erro ao redefinir a senha. Tente novamente.";
          msgDiv.classList.add("error");
          submitBtn.disabled = false;
          submitBtn.innerText = "Confirmar";
        }
      }
    </script>
  </body>
</html>
